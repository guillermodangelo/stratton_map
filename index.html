<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.5.0/dist/geosearch.css"/>
  <title>Test map</title>
  <style>
    
    body {
    padding: 0;
    margin: 0;
   }

    html, body, #map {
        height: 100%;
        width: 100vw;
    }

    .legend {
    width: 200px;
    text-align: left;
    line-height: 23px;
    color: #555;
    clear: both;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 6px;
        opacity: 0.7;
    }

    #logoContainer {
                    position: absolute;
                    z-index: 100;
                    top: 0;
                    left: 45px;
                    background-color: rgba(255, 255, 255, 0.8);
                    width: 200px;
                    height: 120px;
    }

</style>
<style>body { padding: 0; margin: 0; } #map { height: 100%; width: 100vw; }</style>
</head>

<body>
  
  <div id="map">
    <div id="logoContainer">
      <p><img src="logo2.png" alt="WorldVRE Logo" width="75%" height="75%" class="center"></p>
      <p> Buy and sell virtual real estate<br>
      <b> Current map: New York City, NY, USA</b></p>
      <div style="padding:56.25% 0 0 0;position:relative;"><iframe src="https://player.vimeo.com/video/565018069?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;" title="WorldVRE"></iframe></div><script src="https://player.vimeo.com/api/player.js"></script>
      </div>
  </div>



<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geosearch@3.5.0/dist/geosearch.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="./data/hexgrid.js"></script>
<script src="./data/miami.js"></script>
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>


<script>

  var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  var CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  });
  
  var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  });

  const extent = [25.816, -80.234];

	var map = L.map('map', {
		center: extent,
		zoom: 10,
    preferCanvas: true,
		layers: OpenStreetMap_Mapnik
	});

  var baseLayers = {
    "OSM": OpenStreetMap_Mapnik,
    "Image": Esri_WorldImagery,
    "Roads": CartoDB_Positron
    };

L.control.layers(baseLayers).addTo(map);

var mapControlsContainer = document.getElementsByClassName("leaflet-control")[0];
var logoContainer = document.getElementById("logoContainer");

mapControlsContainer.appendChild(logoContainer);

function getColor(d) {
		return	d === 'HIGHEST' ? '#48194c' :
            d === 'HIGH'    ? '#8856a7' :
            d === 'LOWER'   ? '#8c96c6' :
            d === 'LOWEST'  ? '#b3cde3' :
                  '#8856a7';
	}


  function style(feature) {
   var color = getColor(feature.properties.danger_level);
   return {
     fillColor: color ,
     fillOpacity: 1,
     color: color,
     opacity: 1,
     weight: 1,
   };
 }

 map.createPane('myPane');
 map.getPane('myPane').style.opacity = 0.5;
 
 
 var county = L.geoJson(miami, {
   pane: 'myPane'
 }).addTo(map);



 const search = new GeoSearch.GeoSearchControl({
  notFoundMessage: 'Address not found. Contact us to improve this tool.',
  provider: new GeoSearch.OpenStreetMapProvider({
    params: {
      countrycodes: 'us',
      viewbox: [-80.914, 25.115, -80.002, 26.379],
      bounded: 1
    }
  }),
  showMarker: false, // optional: true|false  - default true
  showPopup: false, // optional: true|false  - default false
  //marker: {
  //  icon: new L.Icon.Default(),
  //  draggable: false,
  //},
  //popupFormat: ({ query, result }) => result.label, // optional: function    - default returns result label,
  //resultFormat: ({ result }) => result.label, // optional: function    - default returns result label
  //keepResult: true, // optional: true|false  - default false
  style: 'bar'
});


map.addControl(search);



var polygons = [];

for(var i = 0; i < miami.features.length; i++) {
    var obj = miami.features[i];
    polygons.push(obj);
}

var turf_polygons = turf.featureCollection(polygons);


function searchEventHandler(result) {
  var point = turf.featureCollection([
    turf.point([result.location.x, result.location.y
  ])
]);

  var tagged = turf.tag(point, turf_polygons, 'NAME', 'NAME');
  var result = L.geoJSON(tagged);
  result.addTo(map);

  popup_text = tagged.features[0].properties.NAME

  if (popup_text == null){
    popup_text = 'Outside the AOI'
  }

  var popup = L.popup().setContent(popup_text);
  result.bindPopup(popup).openPopup();
}

map.on('geosearch/showlocation', searchEventHandler);

  
</script>

</body>

</html>